<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schedule Builder (Empty Start)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root{
      --bg: #0f172a; --panel: #1e293b;
      --header-bg: rgba(15, 23, 42, 0.95);
      --grid-line: rgba(51, 65, 85, 0.5);
      --grid-sub-line: rgba(51, 65, 85, 0.2);
      --text-main: #f1f5f9; --text-muted: #94a3b8;
      --input-bg: rgba(255,255,255,0.05);
      --input-border: rgba(255,255,255,0.1);
      --accent-color: #38bdf8;
      
      --hour-width: 100px; 
      --day-height: 100px; 
      --sidebar-width: 90px;
      
      --c-mon: #fbbf24; --c-tue: #f472b6; --c-wed: #34d399;
      --c-thu: #fb923c; --c-fri: #60a5fa; --c-sat: #a78bfa; --c-sun: #f87171;
    }
    body.light {
      --bg: #f8fafc; --panel: #ffffff;
      --header-bg: rgba(248, 250, 252, 0.95);
      --grid-line: #e2e8f0; --grid-sub-line: #f1f5f9;
      --text-main: #0f172a; --text-muted: #64748b;
      --input-bg: #f1f5f9; --input-border: #cbd5e0;
      --accent-color: #0ea5e9;
    }
    * {box-sizing:border-box; font-family: 'Inter', 'Sarabun', sans-serif;}
    body { margin:0; background:var(--bg); color:var(--text-main); display:flex; flex-direction:column; height:100vh; overflow:hidden; user-select:none; }
    
    /* Topbar */
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:0 24px; height:56px; background:var(--panel); border-bottom:1px solid var(--input-border); flex-shrink:0; z-index:30; }
    .topbar h1 { font-size:18px; font-weight:600; margin:0; display:flex; align-items:center; gap:10px; }
    .btn { background:var(--input-bg); border:1px solid var(--input-border); color:var(--text-main); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; font-weight: 500; transition:0.2s; }
    .btn:hover { background:var(--input-border); transform:translateY(-1px); }
    .btn.primary { background:var(--accent-color); color:white; border:none; font-weight: 700; }
    .btn.danger { color:#ef4444; border-color:rgba(239,68,68,0.3); }
    .btn.danger:hover { background:rgba(239,68,68,0.1); }

    /* Main Layout */
    .main { display:flex; flex:1; overflow:hidden; height: calc(100vh - 56px); }
    
    /* Sidebar Panel */
    .panel { 
        width: 320px; background:var(--panel); border-right:1px solid var(--input-border); 
        padding:20px; z-index:20; 
        display:flex; flex-direction:column; 
        flex-shrink: 0;
    }
    .panel h2 { margin:0 0 16px 0; font-size:16px; font-weight: 700; flex-shrink: 0; }
    .add-btn-large { width: 100%; padding: 14px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 16px; flex-shrink: 0; }

    /* Listbox */
    .listbox { 
        flex:1; 
        overflow-y: auto; 
        overflow-x: hidden; 
        border-top: 1px solid var(--input-border); 
        padding-top: 16px; 
        min-height: 0; 
        padding-right: 6px; 
    }
    .listbox::-webkit-scrollbar { width: 6px; }
    .listbox::-webkit-scrollbar-track { background: transparent; }
    .listbox::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    .listbox:hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
    body.light .listbox::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }

    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600; padding-right: 5px;}
    
    .listbox ul { list-style:none; padding:0; margin:0; width: 100%; }
    .listbox li { 
        padding:12px; background:var(--input-bg); border:1px solid var(--input-border); 
        border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items: center;
        cursor:pointer; transition: 0.1s; width: 100%; box-sizing: border-box;
    }
    .listbox li:hover { border-color:var(--accent-color); transform: translateX(2px); }
    .tag-day { width:10px; height:10px; border-radius:2px; margin-right:10px; display:inline-block; flex-shrink: 0; }
    
    .li-content { display: flex; align-items: center; overflow: hidden; flex: 1; min-width: 0; margin-right: 10px; }
    .li-text { display: flex; flex-direction: column; overflow: hidden; }
    .li-name { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .li-code { font-size: 12px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .li-time { text-align: right; font-size: 12px; opacity: 0.7; white-space: nowrap; flex-shrink: 0; }

    /* Schedule Area */
    .schedule-container { flex:1; display:flex; flex-direction:column; background:var(--bg); overflow:hidden; }
    .timeline-header { display:flex; height:40px; background:var(--header-bg); border-bottom:1px solid var(--grid-line); padding-left:var(--sidebar-width); flex-shrink: 0; }
    .time-label { flex: 1; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--text-muted); border-right:1px dashed var(--grid-sub-line); font-weight: 600; }
    
    .schedule-body { flex: 1; display:flex; flex-direction:column; position:relative; }
    .day-row { flex: 1; display:flex; border-bottom:1px solid var(--grid-line); position:relative; min-height: 0; }
    .day-header { width:var(--sidebar-width); flex-shrink:0; background:var(--header-bg); border-right:1px solid var(--grid-line); display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:800; font-size:14px; }
    .day-header::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; }
    
    .day-row[data-day="mon"] .day-header { color:var(--c-mon); } .day-row[data-day="mon"] .day-header::before { background:var(--c-mon); }
    .day-row[data-day="tue"] .day-header { color:var(--c-tue); } .day-row[data-day="tue"] .day-header::before { background:var(--c-tue); }
    .day-row[data-day="wed"] .day-header { color:var(--c-wed); } .day-row[data-day="wed"] .day-header::before { background:var(--c-wed); }
    .day-row[data-day="thu"] .day-header { color:var(--c-thu); } .day-row[data-day="thu"] .day-header::before { background:var(--c-thu); }
    .day-row[data-day="fri"] .day-header { color:var(--c-fri); } .day-row[data-day="fri"] .day-header::before { background:var(--c-fri); }
    .day-row[data-day="sat"] .day-header { color:var(--c-sat); } .day-row[data-day="sat"] .day-header::before { background:var(--c-sat); }
    .day-row[data-day="sun"] .day-header { color:var(--c-sun); } .day-row[data-day="sun"] .day-header::before { background:var(--c-sun); }

    .day-grid { flex:1; position:relative; background-image:linear-gradient(90deg, var(--grid-sub-line) 1px, transparent 1px); background-size: calc(100% / 12) 100%; cursor: cell; }
    .day-grid:hover { background-color:rgba(255,255,255,0.01); }

    /* Class Block */
    .class-block {
        position:absolute; top:4px; bottom:4px; border-radius:8px; padding:6px 8px;
        color:#0f172a; font-size:12px; overflow:hidden; cursor:grab;
        box-shadow:0 2px 4px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.3);
        display:flex; flex-direction:column; justify-content:center; z-index:20;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .class-block:hover { z-index:500; transform:translateY(-2px) scale(1.01); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    
    .block-mon{background:var(--c-mon);} .block-tue{background:var(--c-tue);} .block-wed{background:var(--c-wed);}
    .block-thu{background:var(--c-thu);} .block-fri{background:var(--c-fri);} .block-sat{background:var(--c-sat);} .block-sun{background:var(--c-sun);}

    .block-line { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-right:10px; line-height: 1.25; }
    .block-name { font-weight: 800; font-size: 13px; letter-spacing: -0.3px; }
    .block-code { font-weight: 700; font-size: 12px; opacity: 0.95; }
    .block-info { font-size: 11px; font-weight: 600; opacity: 0.9; color: #334155; }

    .class-block .time-tag { position:absolute; bottom:2px; right:4px; background:rgba(255,255,255,0.6); padding:1px 4px; border-radius:4px; font-size:9px; font-weight:700; pointer-events: none; }

    .block-actions { position:absolute; top:2px; right:2px; display:none; gap:2px; z-index:600; }
    .class-block:hover .block-actions { display:flex; }
    .action-btn { width:20px; height:20px; border-radius:4px; border:1px solid rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:12px; font-weight:bold; background: white; color: #333; }
    .action-btn:hover { transform:scale(1.1); }
    .btn-del { background:#ef4444; color:white; border-color:#dc2626; }
    .resize-handle { position:absolute; right:0; top:0; bottom:0; width:10px; cursor:ew-resize; z-index:50; }
    .class-block:hover .resize-handle { background:linear-gradient(90deg, transparent, rgba(0,0,0,0.1)); }

    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; pointer-events:none; transition:0.2s; }
    .modal.active { opacity:1; pointer-events:auto; }
    .modal-content { background:var(--panel); padding:24px; border-radius:12px; width:400px; border:1px solid var(--input-border); box-shadow:0 20px 40px rgba(0,0,0,0.4); transform:scale(0.95); transition:0.2s; }
    .modal.active .modal-content { transform:scale(1); }
    
    /* Confirm Modal Specific */
    .confirm-box { text-align: center; width: 320px; }
    .confirm-box h3 { margin-bottom: 10px; color: var(--text-main); }
    .confirm-box p { margin-bottom: 20px; color: var(--text-muted); font-size: 14px; }
    .confirm-actions { display: flex; justify-content: center; gap: 10px; }

    label { display:block; font-size:13px; color:var(--text-muted); margin-bottom:4px; }
    input, select { width:100%; padding:10px; background:var(--input-bg); border:1px solid var(--input-border); color:var(--text-main); border-radius:8px; margin-bottom:12px; font-size:14px; outline:none; }
    input:focus, select:focus { border-color:var(--accent-color); }
    option { background-color: var(--panel); color: var(--text-main); padding: 10px; }
    .time-group { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; padding: 2px; margin-bottom: 12px; }
    .time-group select { border: none; margin: 0; background: transparent; text-align: center; padding: 8px; cursor: pointer; flex: 1; }
    .time-group span { font-weight: bold; color: var(--text-muted); padding: 0 4px; }
    .time-group select:hover { background: rgba(255,255,255,0.05); }
    .switch { position:relative; display:inline-block; width:40px; height:22px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#475569; transition:.3s; border-radius:24px; }
    .slider:before { position:absolute; content:""; height:16px; width:16px; left:3px; bottom:3px; background-color:white; transition:.3s; border-radius:50%; }
    input:checked + .slider { background-color:var(--accent-color); }
    input:checked + .slider:before { transform:translateX(18px); }

    @media (max-width:768px){ .main { flex-direction:column; height: auto; } .panel { width:100%; max-height:300px; flex-shrink:0; } .schedule-container { height: 600px; flex-shrink:0;} }
  </style>
</head>
<body>

  <header class="topbar">
    <h1>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
    <div class="top-controls">
      <label class="switch"><input id="themeToggle" type="checkbox"><span class="slider"></span></label>
      <button id="exportPng" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
    </div>
  </header>

  <div class="main">
    <aside class="panel">
      <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
      <button id="openAddBtn" class="btn primary add-btn-large">
          <span>+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà
      </button>
      <div class="listbox">
        <div class="list-header">
            <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤ (<span id="count">0</span>)</span>
            <span id="clearAllLink" style="color:#ef4444; cursor:pointer; font-size:12px;">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        </div>
        <ul id="classList"></ul>
      </div>
    </aside>

    <div class="schedule-container" id="scheduleContainer">
        <div class="timeline-header" id="timelineHeader"></div>
        <div class="schedule-body" id="scheduleBody"></div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; margin-bottom:20px;">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ß‡∏¥‡∏ä‡∏≤</h3>
        <form id="modalForm">
             <input type="hidden" id="mId">
             <label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label><input id="mCode" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 01418111">
             <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label><input id="mName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Computer Science">
             <div class="row-2">
                <div><label>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</label><input id="mTeacher" placeholder="‡∏≠.‡πÉ‡∏à‡∏î‡∏µ"></div>
                <div><label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input id="mRoom" placeholder="SC-401"></div>
             </div>
             <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
             <select id="mDay">
                <option value="mon">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                <option value="tue">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                <option value="wed">‡∏û‡∏∏‡∏ò</option>
                <option value="thu">‡∏û‡∏§‡∏´‡∏±‡∏™</option>
                <option value="fri">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                <option value="sat">‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                <option value="sun">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
             </select>
             <div class="row-2">
                 <div style="flex:1">
                    <label>‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                    <div class="time-group"><select id="msH"></select><span>:</span><select id="msM"></select></div>
                 </div>
                 <div style="flex:1">
                    <label>‡∏à‡∏ö</label>
                    <div class="time-group"><select id="meH"></select><span>:</span><select id="meM"></select></div>
                 </div>
             </div>
             <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                 <button type="button" class="btn" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                 <button type="submit" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
             </div>
        </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content confirm-box">
      <h3 id="confirmTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <p id="confirmMessage">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <div class="confirm-actions">
        <button class="btn" onclick="closeConfirmModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn danger" onclick="confirmDeleteAction()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>

  <script>
    const START_HOUR = 8;
    const END_HOUR = 20;
    const SNAP_MIN = 30;
    const DAY_KEYS = ['mon','tue','wed','thu','fri','sat','sun'];
    const DAY_LABELS = {mon:'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', tue:'‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', wed:'‡∏û‡∏∏‡∏ò', thu:'‡∏û‡∏§‡∏´‡∏±‡∏™', fri:'‡∏®‡∏∏‡∏Å‡∏£‡πå', sat:'‡πÄ‡∏™‡∏≤‡∏£‡πå', sun:'‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'};
    
    let classes = []; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
    let pendingAction = null; 

    // *** CRITICAL FIX: Divide by (END-START) which is 12, NOT +1 ***
    function getMetrics() {
        const gridEl = document.querySelector('.day-grid');
        if(!gridEl) return { hourW: 100 };
        // Correct Division: 20 - 8 = 12 slots
        const hourW = gridEl.offsetWidth / (END_HOUR - START_HOUR);
        return { hourW };
    }

    function initTimeSelects() {
        const hours = [];
        for(let i=START_HOUR; i<=END_HOUR; i++) hours.push(String(i).padStart(2,'0'));
        const mins = ['00', '30'];
        const populate = (hId, mId) => {
            const hSel = document.getElementById(hId);
            const mSel = document.getElementById(mId);
            if(!hSel || !mSel) return;
            hSel.innerHTML = ''; mSel.innerHTML = '';
            hours.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h; opt.textContent = h;
                hSel.appendChild(opt);
            });
            mins.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                mSel.appendChild(opt);
            });
        };
        populate('msH', 'msM'); populate('meH', 'meM');
    }
    function getTimeFromSplit(hId, mId) { return `${document.getElementById(hId).value}:${document.getElementById(mId).value}`; }
    function setTimeToSplit(timeStr, hId, mId) {
        const [h, m] = timeStr.split(':');
        const hSel = document.getElementById(hId);
        const mSel = document.getElementById(mId);
        if(hSel.querySelector(`option[value="${h}"]`)) hSel.value = h;
        const mClean = (parseInt(m) < 15) ? '00' : '30'; 
        mSel.value = mClean;
    }

    // Custom Confirm
    window.deleteClass = function(id, e) {
        if(e) { e.stopPropagation(); e.preventDefault(); }
        pendingAction = { type: 'single', id: id };
        document.getElementById('confirmTitle').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
        document.getElementById('confirmMessage').textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
        document.getElementById('confirmModal').classList.add('active');
    };
    window.closeConfirmModal = function() {
        document.getElementById('confirmModal').classList.remove('active');
        pendingAction = null;
    };
    window.confirmDeleteAction = function() {
        if(!pendingAction) return;
        if(pendingAction.type === 'single' && pendingAction.id) {
            classes = classes.filter(c => c.id !== pendingAction.id);
        } else if (pendingAction.type === 'all') {
            classes = [];
        }
        saveData();
        closeConfirmModal();
    };
    window.editClass = function(id, e) {
        if(e) { e.stopPropagation(); e.preventDefault(); }
        openModalForEdit(id);
    };
    window.closeModal = () => document.getElementById('modal').classList.remove('active');

    function init(){
        initTimeSelects();
        renderGrid();
        loadData();
        if(localStorage.getItem('modernTheme') === 'light'){
            document.body.classList.add('light');
            document.getElementById('themeToggle').checked = true;
        }
        
        document.getElementById('openAddBtn').addEventListener('click', () => {
            openModalForAdd('mon', '09:00');
        });
        document.getElementById('clearAllLink').addEventListener('click', () => {
            if(classes.length === 0) return;
            pendingAction = { type: 'all' };
            document.getElementById('confirmTitle').textContent = '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            document.getElementById('confirmMessage').textContent = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)';
            document.getElementById('confirmModal').classList.add('active');
        });
        document.getElementById('modalForm').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            submitModalForm(); 
        });
        document.getElementById('exportPng').addEventListener('click', () => {
            const el = document.getElementById('scheduleContainer');
            html2canvas(el).then(c => { const a = document.createElement('a'); a.download = 'MySchedule.png'; a.href = c.toDataURL(); a.click(); });
        });
        document.getElementById('themeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('light', e.target.checked);
            localStorage.setItem('modernTheme', e.target.checked ? 'light':'dark');
        });
        
        window.addEventListener('resize', renderClasses);
    }

    function renderGrid(){
        const th = document.getElementById('timelineHeader');
        const sb = document.getElementById('scheduleBody');
        th.innerHTML = ''; sb.innerHTML = '';

        // Loop LESS THAN END_HOUR (8..19) = 12 columns
        for(let h=START_HOUR; h<END_HOUR; h++){
            const div = document.createElement('div');
            div.className = 'time-label';
            div.textContent = `${h}:00`;
            th.appendChild(div);
        }

        DAY_KEYS.forEach(key => {
            const row = document.createElement('div');
            row.className = 'day-row';
            row.dataset.day = key;
            
            const header = document.createElement('div');
            header.className = 'day-header';
            header.innerHTML = `<div>${DAY_LABELS[key]}</div>`;
            
            const grid = document.createElement('div');
            grid.className = 'day-grid';
            
            grid.ondblclick = (e) => {
                if(e.target !== grid) return; 
                const rect = grid.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const { hourW } = getMetrics();
                const clickMin = (x / hourW) * 60;
                let startH = Math.floor(clickMin/60) + START_HOUR;
                let startM = Math.round((clickMin%60)/30)*30;
                if(startM === 60){ startH++; startM=0; }
                const timeStr = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')}`;
                openModalForAdd(key, timeStr);
            };

            row.appendChild(header);
            row.appendChild(grid);
            sb.appendChild(row);
        });
    }

    function loadData(){
        const data = localStorage.getItem('modernSchedule');
        if(data) {
            classes = JSON.parse(data);
        } else {
            classes = []; // Start Empty
        }
        renderClasses();
    }
    function saveData(){ 
        localStorage.setItem('modernSchedule', JSON.stringify(classes)); 
        renderClasses(); 
    }

    function renderClasses(){
        document.querySelectorAll('.class-block').forEach(el => el.remove());
        const list = document.getElementById('classList');
        list.innerHTML = '';
        document.getElementById('count').innerText = classes.length;

        const { hourW } = getMetrics();

        classes.forEach(c => {
            const row = document.querySelector(`.day-row[data-day="${c.day}"] .day-grid`);
            if(row){
                const startMin = timeToMin(c.start);
                const leftPx = ((startMin - (START_HOUR*60)) / 60) * hourW;
                const widthPx = (c.duration * hourW);
                const endMin = startMin + (c.duration * 60);
                const timeRange = `${c.start} - ${minToTime(endMin)}`;

                const block = document.createElement('div');
                block.className = `class-block block-${c.day}`;
                block.dataset.id = c.id;
                block.style.left = `${leftPx}px`;
                block.style.width = `${widthPx}px`;
                
                block.innerHTML = `
                    <div class="block-line block-name">${c.name}</div>
                    <div class="block-line block-code">${c.code}</div>
                    <div class="block-line block-info">${c.teacher} &nbsp;‚Ä¢&nbsp; ${c.room}</div>
                    <div class="time-tag">${timeRange}</div>
                    <div class="resize-handle"></div>
                    <div class="block-actions">
                        <div class="action-btn btn-edit" onclick="editClass('${c.id}', event)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úé</div>
                        <div class="action-btn btn-del" onclick="deleteClass('${c.id}', event)" title="‡∏•‡∏ö">‚úï</div>
                    </div>
                `;

                block.onmousedown = (e) => {
                    if(e.target.closest('.block-actions') || e.target.closest('.resize-handle')) return;
                    startDrag(e, c.id);
                };
                block.querySelector('.resize-handle').onmousedown = (e) => startResize(e, c.id);
                
                row.appendChild(block);
            }

            const li = document.createElement('li');
            li.innerHTML = `
                <div class="li-content">
                    <span class="tag-day" style="background:var(--c-${c.day})"></span>
                    <div class="li-text">
                        <div class="li-name">${c.name}</div>
                        <div class="li-code">${c.code}</div>
                    </div>
                </div>
                <div class="li-time">${DAY_LABELS[c.day]}<br>${c.start}</div>
            `;
            li.onclick = () => openModalForEdit(c.id);
            list.appendChild(li);
        });
    }

    function timeToMin(t){ const [h,m] = t.split(':').map(Number); return h*60+m; }
    function minToTime(m){ const h=Math.floor(m/60); const mn=m%60; return `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`; }
    function snap(val){ return Math.round(val/SNAP_MIN)*SNAP_MIN; }
    
    function getDuration(start, end){
        let s = timeToMin(start), e = timeToMin(end);
        if(e <= s) e = s + 60; 
        return (e - s) / 60;
    }

    function submitModalForm(){
        const getVal = (id) => document.getElementById(id).value;
        let startVal = getTimeFromSplit('msH', 'msM');
        let endVal = getTimeFromSplit('meH', 'meM');
        const durationVal = getDuration(startVal, endVal);

        const item = {
            id: getVal('mId') ? getVal('mId') : Date.now().toString(),
            code: getVal('mCode'), name: getVal('mName'), 
            teacher: getVal('mTeacher'), room: getVal('mRoom'), 
            day: getVal('mDay'), start: startVal, duration: durationVal
        };
        const idx = classes.findIndex(x=>x.id===item.id);
        if(idx > -1) classes[idx] = item; else classes.push(item);
        saveData();
        closeModal();
    }

    let dragItem = null;
    function startDrag(e, id){
        if(e.button !== 0) return;
        e.preventDefault();
        const c = classes.find(x=>x.id===id);
        dragItem = { id, startX:e.clientX, startY:e.clientY, el:e.currentTarget, origStart:timeToMin(c.start), isMoved:false };
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
        dragItem.el.style.zIndex = 1000;
    }
    function onDrag(e){
        if(!dragItem) return;
        const dx = e.clientX - dragItem.startX;
        const dy = e.clientY - dragItem.startY;
        if(Math.abs(dx)>3 || Math.abs(dy)>3) {
            dragItem.isMoved = true;
            dragItem.el.style.cursor = 'grabbing';
            dragItem.el.style.transform = `translate(${dx}px, ${dy}px)`;
            dragItem.el.style.transition = 'none';
        }
    }
    function endDrag(e){
        if(!dragItem) return;
        if(dragItem.isMoved){
            const { hourW } = getMetrics();
            const dx = e.clientX - dragItem.startX;
            const minChange = Math.round((dx/hourW)*60);
            let newStart = snap(dragItem.origStart + minChange);
            newStart = Math.max(START_HOUR*60, Math.min(END_HOUR*60, newStart));
            
            const rows = Array.from(document.querySelectorAll('.day-row'));
            const containerRect = document.getElementById('scheduleBody').getBoundingClientRect();
            const currentY = e.clientY - containerRect.top;
            const rowH = containerRect.height / 7; 
            let rowIndex = Math.floor(currentY / rowH);
            rowIndex = Math.max(0, Math.min(6, rowIndex));
            
            const idx = classes.findIndex(x=>x.id===dragItem.id);
            classes[idx].start = minToTime(newStart);
            classes[idx].day = DAY_KEYS[rowIndex];
            saveData();
        } else {
            dragItem.el.style.zIndex = '';
            dragItem.el.style.transform = '';
        }
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        dragItem = null;
    }

    function startResize(e, id){
        e.stopPropagation(); e.preventDefault();
        dragItem = { id, startX:e.clientX, mode:'resize' };
        document.addEventListener('mousemove', onResize);
        document.addEventListener('mouseup', endResize);
    }
    function onResize(e){}
    function endResize(e){
        if(!dragItem) return;
        const { hourW } = getMetrics();
        const idx = classes.findIndex(x=>x.id===dragItem.id);
        const dx = e.clientX - dragItem.startX;
        const durChange = dx/hourW;
        let newDur = Math.max(0.5, Math.round((classes[idx].duration + durChange)*2)/2);
        classes[idx].duration = newDur;
        saveData();
        document.removeEventListener('mousemove', onResize);
        document.removeEventListener('mouseup', endResize);
        dragItem = null;
    }

    function openModalForEdit(id){
        const c = classes.find(x=>x.id===id);
        if(!c) return;
        document.getElementById('modalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        document.getElementById('mId').value = c.id;
        document.getElementById('mCode').value = c.code;
        document.getElementById('mName').value = c.name;
        document.getElementById('mTeacher').value = c.teacher;
        document.getElementById('mRoom').value = c.room;
        document.getElementById('mDay').value = c.day;
        setTimeToSplit(c.start, 'msH', 'msM');
        const endMin = timeToMin(c.start) + (c.duration*60);
        setTimeToSplit(minToTime(endMin), 'meH', 'meM');
        document.getElementById('modal').classList.add('active');
    }
    function openModalForAdd(day, timeStr){
        document.getElementById('modalForm').reset();
        document.getElementById('modalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('mId').value = '';
        document.getElementById('mDay').value = day;
        setTimeToSplit(timeStr, 'msH', 'msM');
        const endMin = timeToMin(timeStr) + 60; 
        setTimeToSplit(minToTime(endMin), 'meH', 'meM');
        document.getElementById('modal').classList.add('active');
    }

    init();
  </script>
</body>
</html>
